# 从 IVR 进入排队
<!-- toc -->

使用 `<enqueue>` [IVR](../../ivr/index.md) 节点，对 IVR 的当前呼叫进行 ACD 排队。

该 IVR 形如：
```xml
<enqueue
        channel="channel1"
        wait_voice="wait.wav"
        ring_mode="4"
        play_num="true"
        pre_num_voice="坐席.wav"
        post_num_voice="为您服务.wav"
        data="your or data whatever here!"
>
    <route>
        <condition name="condition1"/>
        <condition name="condition2"/>
    </route>
    <route>
        <condition name="condition3"/>
        <target name="agent001" priority=99 timeout="5">
    </route>
</enqueue>
```

## 过程简述

- 1. 开始排队后，按照第一个`<route>`内的`<condition>`进行排队
    - 1.1. 定位到该`<route>`内的第一个`<condition>`可以找到可用坐席？
    - 1.1. 该`<condition>`可以找到可用坐席？
        - 1.1.1. 如果可以，则连接这个坐席
        - 1.1.2. 如果没有，定位`<route>`内的下一个`<condition>`，跳转到 1.1
    - 1.2. 如果该`<route>`内的所有`<condition>`都没有找到可用坐席，排队任务就按照这些条件进行等待，直到所有的`<condition>`都超时
        - 1.2.1. 如果等待期间有坐席状态变化后，满足其中至少一个条件，则该坐席选中其中优先级别最高的条件所对应的排队任务，优先级别一样时选择等待时间最长的
- 2. 如果该`<route>`中所有的`<condition>`都等待超时，则认为排队任务在该`<route>`上出现一次溢出，应转到下一个`<route>`继续
    - 2.1. 还有下一个`<route>`？
        - 2.1.1 有则定位到这个`<route>`，并跳转到 1.1
        - 2.1.2 无则排队超时

## `<enqueue>`属性列表

属性名称               | 有效值范围            | 必填 |   默认值     | 说明
---------------------- | ----------------------| ---- | ------------ | ----------------------------
`channel`              | 工作通道名称          | √    |              | 在该通道排队，必须使用这个通道上的坐席、排队条件
`conversation_level`   | `1`, `2`              |      | `2`          | 该排队成功并建立交谈后，此次交谈的级别。级别`1`无法形成3方通话。
`conversation_timeout` | 正整数                |      |              | 该排队成功并建立交谈后，此次交谈的最大允许持续时间（秒）。不填写表示最大值无穷大（整个呼叫的超时时间仍然受到的其最大允许时间的限制）
`reserve_state`        | 状态字符串            |      | `idle`       | 该排队成功并建立交谈后，被排到的坐席如果分机挂断，则状态变成这个值
`fail_overflow`        | `true`, `false`       |      | `false`      | 是否将连接坐席分机失败视作排队溢出。是则按照溢出规则继续排队；否则排队失败退出。
`wait_voice`           | 录音文件名            |      | 空字符串     | 排队时，播放的等待声音文件
`ring_mode`            | 整数 1~4              |      | 1            | 呼叫坐席分机期间对排队中的通话的放音模式
`ring_voice`           | 录音文件名            |      | 空字符串     | 呼叫坐席分机期间对排队中的通话播放的声音文件
`hold_voice`           | 录音文件名            |      | 空字符串     | 该排队成功并建立交谈后，如果交谈中的活动呼叫只剩下一个，则在交谈中播放这个声音文件
`play_num`             | `true`, `false`       |      | `false`      | 是否在接通坐席分机后播放该坐席的工号
`pre_num_voice`        | 录音文件名            |      | 空字符串     | 播放工号前播放的声音文件
`post_num_voice`       | 录音文件名            |      | 空字符串     | 播放工号后播放的声音文件
`data`                 | 任意字符串            |      | 空字符串     | 用户数据，当排队状态发生变化时，平台向用户应用服务发起的事件通知或IVR请求将带有该参数

#### `ring_mode`属性

枚举值 | 说明
------ | -----
`1`    | 对目标坐席的分机发起呼叫时即播放`ring_voice`指定的声音文件，收到坐席分机回铃后停止播放，并透传回铃音，直到坐席分机接听或者呼叫结束。
`2`    | 对目标坐席的分机发起呼叫时即播放`ring_voice`指定的声音文件，直到坐席分机接听或者挂机后停止播放，直到坐席分机接听或者呼叫结束。
`3`    | 对目标坐席的分机发起呼叫时继续播放`wait_voice`指定的声音文件，直到收到目标坐席分机的回铃后，播放`ring_voice`指定的声音文件，直到坐席分机接听或者呼叫结束。
`4`    | 对目标坐席的分机发起呼叫时继续播放`wait_voice`指定的声音文件，收到坐席分机回铃后停止播放，并透传回铃音，直到坐席分机接听或者呼叫结束。此时`ring_voice`参数无效。

## `<route>`节点
`<route>`是排队条件(`<condition>`)的容器。

`<enqueue>` **必须** 包含 **至少一个** `<route>`节点。

排队时，平台按照`<route>`在 XML 中的顺序，依次使用其中的`<condition>`进行排队。

如果一个`<route>`中所有`<condition>`都排队超时，则使用下一个`<route>`继续排队。这种情况被称为“排队溢出”。

## `<condition>`节点
IVR 使用该节点表明使用哪个 [排队条件](condition.md) ，这些条件需要预先进行设置。

这个节点的父节点必须是`<route>`

### `<condition>`属性列表

属性名称               | 有效值范围            | 必填 |   默认值     | 说明
---------------------- | ----------------------| ---- | ------------ | ----------------------------
`name`                 | 排队条件名称          | √    |              | 这个排队条件所在的工作通道(`channel`) **必须** 和`<enqueue>`的`channel`属性一致！

## `<target>`节点
用于直接定位到坐席

属性名称               | 有效值范围            | 必填 |   默认值     | 说明
---------------------- | ----------------------| ---- | ------------ | ----------------------------
`name`                 | 坐席名称              | √    |              | 该所在的工作通道(`channel`) **必须** 和`<enqueue>`的`channel`属性一致！
`priority`             | 整数                  |      |  `0`         | 排队优先级
`timeout`              | 正整数                |      | `""`         | 排队等待+坐席分机接听的总超时时间件，不填表示超时值是无穷大。
